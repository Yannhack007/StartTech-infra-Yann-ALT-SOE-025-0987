name: Deploy Infrastructure

on:
  push:
    branches:
      - main
    paths:
      - 'terraform/**'
      - 'scripts/**'
      - '.github/workflows/infrastructure-deploy.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'terraform/**'
      - 'scripts/**'
      - '.github/workflows/infrastructure-deploy.yml'
  workflow_dispatch:
    inputs:
      auto_approve:
        description: 'Auto approve and apply changes (only on main branch)'
        required: false
        default: 'false'

env:
  TERRAFORM_VERSION: 1.6.6
  AWS_REGION: eu-north-1
  ARTIFACT_NAME: terraform-plan

jobs:
  # Job 1: Validate and Plan
  validate-and-plan:
    name: Validate & Plan Terraform
    runs-on: ubuntu-latest
    outputs:
      plan-status: ${{ steps.plan.outcome }}
      has-changes: ${{ steps.plan.outputs.has-changes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # Validate shell scripts syntax
      - name: Validate Shell Scripts
        run: |
          for script in scripts/*.sh; do
            if [ -f "$script" ]; then
              echo "Checking syntax: $script"
              bash -n "$script" || exit 1
            fi
          done

      - name: Terraform Format Check
        working-directory: terraform
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Validate
        working-directory: terraform
        run: terraform validate

      - name: Terraform Plan
        id: plan
        working-directory: terraform
        shell: bash {0}
        run: |
<<<<<<< Updated upstream
          echo "========================================="
          echo " Starting Terraform Plan..."
          echo "========================================="
          
          # Run terraform plan and capture output
          terraform plan -detailed-exitcode -no-color -out=tfplan > plan_output.txt 2>&1 || true
          cat plan_output.txt
          
          # Force exit code based on plan content
          if grep -q "Plan: [1-9]" plan_output.txt; then
            PLAN_EXIT_CODE=2
            echo "CHANGES DETECTED - Forcing exit code 2"
          elif grep -q "No changes" plan_output.txt; then
            PLAN_EXIT_CODE=0
            echo "NO CHANGES - Exit code 0"
=======
          terraform plan -out=tfplan -no-color > plan.txt 2>&1
          exit_code=$?
          
          # Check if there are changes
          if grep -q "No changes" plan.txt; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
>>>>>>> Stashed changes
          else
            echo "has-changes=true" >> $GITHUB_OUTPUT
          fi
          
<<<<<<< Updated upstream
          echo "exitcode=$PLAN_EXIT_CODE" >> $GITHUB_OUTPUT
          
          echo ""
          echo "========================================="
          echo "Terraform Plan Exit Code: $PLAN_EXIT_CODE"
          echo "========================================="
          
          case $PLAN_EXIT_CODE in
            0)
              echo "No changes - infrastructure is up to date"
              echo "Apply job will be SKIPPED"
              ;;
            1)
              echo "Terraform plan FAILED"
              echo "Check errors above"
              exit 1
              ;;
            2)
              echo "Changes detected!"
              echo "Apply job will RUN to create/modify resources"
              echo ""
              echo "Showing plan summary..."
              terraform show tfplan | grep -E "Plan:|# |will be created|will be updated|will be destroyed" | head -50
              ;;
              
            *)
              echo "Unexpected exit code: $PLAN_EXIT_CODE"
              exit 1
              ;;
          esac
          
          echo "========================================="
=======
          exit $exit_code
        continue-on-error: true
>>>>>>> Stashed changes

      - name: Save Plan Output
        working-directory: terraform
        run: |
          terraform show -json tfplan > tfplan.json

      # Upload plan as artifact
      - name: Upload Terraform Plan
        if: always()
        uses: actions/upload-artifact@v4
        if: steps.plan.outputs.exitcode == '2'
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: terraform/
          retention-days: 7

<<<<<<< Updated upstream
      - name: Plan Summary
        if: always()
        run: |
          echo "## Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          EXITCODE="${{ steps.plan.outputs.exitcode }}"
          
          echo "**Exit Code:** \`$EXITCODE\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$EXITCODE" == "0" ]; then
            echo "### No Changes Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure is already up to date." >> $GITHUB_STEP_SUMMARY
          elif [ "$EXITCODE" == "1" ]; then
            echo "### Plan Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for error details." >> $GITHUB_STEP_SUMMARY
          elif [ "$EXITCODE" == "2" ]; then
            echo "### Changes Will Be Applied" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Terraform detected changes and will apply them." >> $GITHUB_STEP_SUMMARY
          fi

  terraform-apply:
=======
      # Comment on PR with plan
      - name: Comment Plan on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('terraform/plan.txt', 'utf8');
            
            // Truncate if too long
            const truncated = planOutput.length > 60000 
              ? planOutput.substring(0, 60000) + '\n... (truncated)'
              : planOutput;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Terraform Plan\n\`\`\`\n${truncated}\n\`\`\``
            });

  # Job 2: Apply (only on main, requires manual approval)
  apply:
>>>>>>> Stashed changes
    name: Apply Terraform Changes
    needs: validate-and-plan
    runs-on: ubuntu-latest
<<<<<<< Updated upstream
    needs: terraform-plan
    if: needs.terraform-plan.outputs.tfplanExitCode == '2' &&
      (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
    environment: production
=======
    if: |
      github.ref == 'refs/heads/main' && 
      github.event_name != 'pull_request' &&
      needs.validate-and-plan.outputs.has-changes == 'true'
    environment:
      name: Production
      # Uncomment for manual approval before apply:
      # deployment-branch-policy:
      #   protected-branches: true
>>>>>>> Stashed changes
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download Terraform Plan
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: terraform/

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Apply
        working-directory: terraform
        run: |
          if [ -f tfplan ]; then
            terraform apply -no-color tfplan
          else
            echo "Plan file not found!"
            exit 1
          fi

      - name: Terraform Outputs
        id: outputs
        working-directory: terraform
        run: |
          echo "## Terraform Outputs" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          terraform output -no-color >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload Outputs
        uses: actions/upload-artifact@v4
        with:
          name: deployment-outputs
          path: terraform/
          retention-days: 30

      - name: Notify Success
        if: success()
        run: |
          echo "Infrastructure deployment successful!"
          echo ""
          echo "## Deployment Summary"
          echo "- Region: ${{ env.AWS_REGION }}"
          echo "- Timestamp: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          echo ""
          echo "Check the deployment-outputs artifact for terraform outputs."

  # Job 3: Summary
  summary:
    name: Deployment Summary
    needs: [validate-and-plan, apply]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Create Summary
        run: |
          echo "## Infrastructure Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.validate-and-plan.outputs.plan-status }}" = "success" ]; then
            echo "Validation: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "Validation: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.apply.result }}" = "success" ]; then
            echo "Apply: Success" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.apply.result }}" = "skipped" ]; then
            echo "Apply: Skipped (no changes or not on main)" >> $GITHUB_STEP_SUMMARY
          else
            echo "Apply: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download artifacts for more details." >> $GITHUB_STEP_SUMMARY